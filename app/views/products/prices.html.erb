<% content_for :titulo_pagina do %>Precios<% end %>
<% content_for :javascript do %>
<%= javascript_include_tag "https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" %>
<script type="text/javascript">jQuery.noConflict();</script>
<%= javascript_include_tag "highcharts", "modules/exporting", "chosen.jquery.min", "tooltipsy.min" %>

<script type="text/javascript">
function agregar_tooltips() {
	jQuery('div[id^="tooltipsy"]').remove()
	jQuery('li.search-choice > span').each(function(i) {
		jQuery(this).tooltipsy({
			content: jQuery(this).parent().parent().parent().siblings().first().attr('title'),
			alignTo: 'cursor',
			offset: [10, 10]
		});
	});
}

var spinner = '<%= image_tag "ajax-bar-loader.gif", :size => "238x30" %>';
var pulldowns_ok = [
	{ 
		name: "Categoria",
		campo: "categoria"
	},
	{
		name: "Retailer",
		campo: "retailer" 	
	}
];
<% for p in @properties %>
pulldowns_ok.push({ name: '<%=p[:name]%>', campo: '<%=p[:field]%>', id: <%=p[:id]%> });
<% end %>

function find_prop(campo) {
	var indice = -1;
	jQuery.each(pulldowns_ok, function(i, v) {
		if (v.campo == campo) {
			indice = i;
		}
	})
	return indice;
}

function cascada_de_pulldowns(obj) {
	agregar_tooltips();

	var indice = find_prop(obj.name);
	if (indice < 0) {
		return;
	}

	for (
		var i = indice + 1;
		i < pulldowns_ok.length;
		i++
	) {
		dibujar_pulldown( i, pulldowns_ok[i].campo, pulldowns_ok[i].name );
	}

	dibujar_pulldown_productos();
}

function dibujar_pulldown_productos() {
	jQuery('#span_producto_pulldown').html(spinner);

	var campos = {};
	for ( var i = 0; i < pulldowns_ok.length; i++ ) {
		if (jQuery(pulldowns_ok[i].campo + '_pulldown').val()) {
			campos[pulldowns_ok[i].campo] = jQuery(pulldowns_ok[i].campo + '_pulldown').val();
		}
	}

	jQuery.ajax({
		url: ( jQuery.param(campos) != '' ? "/products/search" : "/products" ),
		data: campos,
		cache: false,
		statusCode: {
			200: function(data) {
				llenar_pulldown(data, 'producto', 'Producto');
			},
			400: function() {
				alert('Error 400!');
			}
		}
	});
}

function dibujar_pulldown(indice, campo, nombre) {
	jQuery('#span_' + campo + '_pulldown').html = spinner;

	var campos = { property: pulldowns_ok[indice].id };

	for (
		var i = 0;
		i < indice;
		i++
	) {
		if (jQuery(pulldowns_ok[i].campo + '_pulldown').val()) {
			campos[pulldowns_ok[i].campo] = jQuery(pulldowns_ok[i][campo] + '_pulldown').val();
		}
		
	}

	jQuery.ajax({
		url: "/property_values/search",
		data: campos,
		cache: false,
		statusCode: {
			200: function(data) {
				llenar_pulldown(data, campo, nombre);
			},
			400: function(){
				alert('Error 400!');
			}
		}
	});
}

function llenar_pulldown(data, campo, name) {
	var change = '';
	if (campo != 'producto') {
		change = 'onChange="cascada_de_pulldowns(this);" ';
	}

	var select = jQuery('<select ' + change + 'name="' + campo + '" id="' + campo + '_pulldown" class="pulldown_selector chzn-select" size="4" multiple  title="' + name + '" data-placeholder="' + name + '"></select>');
		
	if (campo == 'producto') {
		var productos = [];
		jQuery.each(data, function(i, v) {
			var producto = '';

			jQuery.each(v.property_values, function(j, prop) {
				if (prop.property_name == 'marca') {
					producto += prop.value;
				}				
			});
			jQuery.each(v.property_values, function(j, prop) {
				if (prop.property_name == 'modelo') {
					producto += ' ' + prop.value;
				}				
			});

			if (producto) {
				productos.push( { id: v.id, value: producto })
			}
		});

		var productos_ordered = productos.sort( function(a,b) {
			return ( a.value < b.value ? -1 : (a.value > b.value ? 1 : 0 ) );
		});

		for (var i = 0; i < productos_ordered.length; i++) {
			select.append('<option value="' + productos_ordered[i].id + '">' + productos_ordered[i].value + '</option>');
		};
	} else {
		var props_ordered = data.sort(function(a, b) {
			return ( a.value < b.value ? -1 : (a.value > b.value ? 1 : 0 ) );
		});
		
		for (var i = 0; i < props_ordered.length; i++) {
			select.append('<option value="' + props_ordered[i].id + '">' + props_ordered[i].value + '</option');
		}
	}

	jQuery('#span_' + campo + '_pulldown').html(select);
	jQuery('#' + campo + '_pulldown').chosen();
	jQuery('#' + campo + '_pulldown').bind('change', agregar_tooltips);
}

jQuery(document).ready(function() {
	jQuery(".chzn-select").chosen();
	jQuery("#fecha_desde").datepicker();
	jQuery("#fecha_hasta").datepicker();
	//dibujar_pulldown_productos();
});

</script>
<%= javascript_include_tag "jquery-ui-1.8.14.custom.min", "jquery-ui-datepicker-es" %>
<% end %>

<style type="text/css">

.pulldown_selector {
	font-size: 12px;
	width: 240px;
}

span.error {
	position: relative;
	top: 180px;
	left: 100px;
	font-size: 16px;
	font-weight: bold;
}

</style>

<div style="height: 600px; width: 250px;">

<form name="buscar_producto" id="buscar_producto">
<input type="hidden" name="class" value="pulldown_selector chzn-select"/>
<input type="hidden" name="data-placeholder" value="Producto"/>
<input type="hidden" name="title" value="Producto"/>

<span class="pulldown_span" id="span_categoria_pulldown">
<select onChange="cascada_de_pulldowns(this);" name="categoria" id="categoria_pulldown" class="pulldown_selector chzn-select" size="4" multiple  title="Categor&iacute;a" data-placeholder="Categor&iacute;a">
<%= render :partial => "shared/pulldown_options", :collection => @categorias, :as => :obj %>
</select></span><span class="pulldown_span" id="span_retailer_pulldown"><select name="retailer" onChange="cascada_de_pulldowns(this);" size="4" title="Retailer" id="retailer_pulldown" class="pulldown_selector chzn-select" multiple  data-placeholder="Retailer">
<%= render :partial => "shared/pulldown_options", :collection => @retailers, :as => :obj %>
</select></span>

<% for p in @properties %>
<span class="pulldown_span" id="span_<%= p[:field] %>_pulldown">
<select onChange="cascada_de_pulldowns(this);" name="<%= p[:field] %>" id="<%= p[:field] %>_pulldown" class="pulldown_selector chzn-select" size="4" multiple  title="<%= p[:name] %>" data-placeholder="<%= p[:name] %>">
<%= render :partial => "shared/pulldown_options_array", :collection => p[:props].sort { |a, b| a[:name] <=> b[:name] }, :as => :obj %>
</select></span>
<% end %>

</form>

<form name="parametros_grafico" id="parametros_grafico" method="post" action="/dashboard/hc_grafico_producto" target="_new">
<input type="hidden" name="t" id="t">
<input type="hidden" name="excel" id="excel">
<input type="hidden" name="retailer" id="retailer">

<span class="pulldown_span" id="span_producto_pulldown"><select name="producto" id="producto_pulldown" class="pulldown_selector chzn-select" size="8" multiple="multiple" title="Producto" data-placeholder="Producto">
</select>
</span>
<br/>
<br/>
<%= render "shared/periodo_pulldown" %>
<br/>
<div class="date_div" style="display: inline; float: left">
Desde:
<input class="date_input" type="text" name="fecha_desde" id="fecha_desde" size="8" value="<%= (Date.current - 1.month).strftime("%d/%m/%Y") %>"/>
</div>

<div class="date_div">
Hasta:
<input class="date_input" type="text" name="fecha_hasta" id="fecha_hasta" size="8" value="<%= (Date.current).strftime("%d/%m/%Y") %>"/>
</div>

<input type="button" onClick="graficar();" id="boton_ver" value="Ver"/>
<input type="button" onClick="graficar('excel');" id="boton_ver_excel" value="Ver Excel"/>
</form>

</div>

<div style="position: relative; top: -600px; left: 250px; width: 550px; height: 500px;" id="chart">
<div id="chart_producto" style="height: 500px; width: 550px;"></div>
<div style="display: none; width: 550px;" id="history_buttons">
<p style="text-align: center;">
<input type="button" id="history_back" disabled value="&lt;--" onClick="showhistorychart(-1);">&nbsp;
<input type="button" id="history_forward" disabled value="--&gt;" onClick="showhistorychart(1);">&nbsp;
</p>
</div>
</div>

<script type="text/javascript">

</script>